<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ธรรมสรณ์.io — By Kenta</title>
  <style>
    :root{--bg:#071025;--muted:#94a3b8;--accent:#ffd166}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:var(--bg);color:#e6eef6}
    .stage{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
    .hero{position:relative;flex:1;display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#06101a;cursor:pointer;user-select:none}
    .hero img{max-width:100%;max-height:100%;width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
    .counter-badge{position:absolute;top:18px;left:18px;background:rgba(0,0,0,0.45);padding:8px 12px;border-radius:10px;font-weight:800;color:var(--accent);backdrop-filter:blur(4px);}
    .plus{position:absolute;pointer-events:none;font-weight:800;font-size:28px;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.6);animation:floatUp .9s cubic-bezier(.16,.9,.34,1);}
    @keyframes floatUp{0%{transform:translateY(0) scale(1);opacity:1}70%{transform:translateY(-80px) scale(1.08);opacity:1}100%{transform:translateY(-120px) scale(.95);opacity:0}}
    .bottom-bar{position:fixed;left:0;right:0;bottom:0;height:84px;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:space-between;padding:12px 20px;gap:12px;border-top:1px solid rgba(255,255,255,0.03)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:10px 14px;border-radius:10px;color:inherit;cursor:pointer;font-weight:700}
    .small{padding:8px 10px;font-size:14px}
    .leaderboard{min-width:220px;max-width:320px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;overflow:auto;max-height:64px}
    input[type=text]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .muted{color:var(--muted);font-size:13px}
    @media(max-width:780px){ .bottom-bar{flex-direction:column;height:auto;padding:10px} .leaderboard{max-width:100%;width:100%} }
  </style>
</head>
<body>
  <div class="stage" role="application" aria-label="Popcat fullscreen">
    <div class="hero" id="hero" aria-label="Click to pop">
      <img id="imgClosed" alt="popcat closed" src="" draggable="false"/>
      <img id="imgOpen" alt="popcat open" src="" style="display:none;position:absolute;left:0;top:0;width:100%;height:100%;object-fit:cover" draggable="false"/>
      <div class="counter-badge" id="counter">0</div>
    </div>

    <div class="bottom-bar" role="toolbar" aria-label="Controls bar">
      <div class="controls left-controls">
        <button id="resetBtn" class="btn small" title="รีเซ็ตคะแนน">รีเซ็ต</button>
        <button id="saveBtn" class="btn small" title="บันทึกคะแนน">บันทึก</button>
        <button id="toggleBot" class="btn small" title="เริ่ม/หยุดบอท">เริ่ม</button>
        <label class="muted" style="margin-left:6px">Bot speed:</label>
        <input id="botSpeed" type="range" min="10" max="1000" value="200" style="width:140px"/>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="leaderboard" id="leaderboard" aria-live="polite">ยังไม่มีคะแนน</div>
        <div style="display:flex;align-items:center;gap:8px">
          <input id="nameInput" type="text" placeholder="ชื่อ (เช่น คนดีย์)" style="min-width:150px"/>
          <button id="submitScore" class="btn small">บันทึก</button>
        </div>
      </div>
    </div>
  </div>

<script>
// --- CONFIG
const imgClosedSrc = 'https://img5.pic.in.th/file/secure-sv1/Blue-and-Green-Glassy-Nature-Desktop-Wallpaper.png';
const imgOpenSrc = 'https://img2.pic.in.th/pic/581057723_896655819567396_2736182994753000191_n.png';
const imgMilestoneSrc = 'https://img5.pic.in.th/file/secure-sv1/Blue-and-Green-Glassy-Nature-Desktop-Wallpaper.png';

const COUNT_KEY = 'popcat_full_count_v1'
const LB_KEY = 'popcat_full_lb_v1'

let count = Number(localStorage.getItem(COUNT_KEY) || 0)
let botInterval = null
let botRunning = false

const imgClosed = document.getElementById('imgClosed')
const imgOpen = document.getElementById('imgOpen')
const counterEl = document.getElementById('counter')
const resetBtn = document.getElementById('resetBtn')
const toggleBot = document.getElementById('toggleBot')
const botSpeed = document.getElementById('botSpeed')
const leaderboardEl = document.getElementById('leaderboard')
const nameInput = document.getElementById('nameInput')
const submitScore = document.getElementById('submitScore')
const saveBtn = document.getElementById('saveBtn')
const hero = document.getElementById('hero')

// set images
imgClosed.src = imgClosedSrc || ''
imgOpen.src = imgOpenSrc || ''

// update counter
function updateCounter(){ 
  counterEl.textContent = count.toLocaleString('en-US'); 
  localStorage.setItem(COUNT_KEY, String(count)) 
}

// create +1 floating animation
function makePlus(x,y){
  const p = document.createElement('div')
  p.className = 'plus'
  p.textContent = '+1'
  hero.appendChild(p)
  const wrap = hero.getBoundingClientRect()
  p.style.left = (x - wrap.left - 12) + 'px'
  p.style.top = (y - wrap.top - 20) + 'px'
  setTimeout(()=>p.remove(),900)
}

// audio
const AudioCtx = window.AudioContext || window.webkitAudioContext
const audioCtx = AudioCtx ? new AudioCtx() : null

function playClickSound(){ 
  if(!audioCtx) return
  const o=audioCtx.createOscillator()
  const g=audioCtx.createGain()
  o.type='sine'
  o.frequency.value=880
  g.gain.value=0.02
  o.connect(g)
  g.connect(audioCtx.destination)
  o.start()
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.09)
  o.stop(audioCtx.currentTime + 0.11)
}

function playMilestoneSound(){ 
  if(!audioCtx) return
  const now=audioCtx.currentTime
  const notes=[440,660,880,1100]
  notes.forEach((f,i)=>{ 
    const o=audioCtx.createOscillator()
    const g=audioCtx.createGain()
    o.type='sine'
    o.frequency.value=f
    g.gain.value=0.03
    o.connect(g)
    g.connect(audioCtx.destination)
    o.start(now + i*0.08)
    g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.08 + 0.12)
    o.stop(now + i*0.08 + 0.14)
  })
}

// click handling
function doClick(clientX, clientY){
  count += 1
  updateCounter()
  makePlus(clientX, clientY)
  playClickSound()
  flashOpen()
  if(count % 1000 === 0) triggerMilestone()
}

// รองรับคลิกและทัชทั้ง hero
hero.addEventListener('click',(e)=>{ doClick(e.clientX,e.clientY) })
hero.addEventListener('touchstart',(e)=>{ e.preventDefault(); const t=e.touches[0]; doClick(t.clientX,t.clientY) })
hero.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); doClick(window.innerWidth/2,window.innerHeight/2) } })

function flashOpen(){
  if(imgOpen.src){
    imgClosed.style.display='none'
    imgOpen.style.display='block'
    setTimeout(()=>{ imgOpen.style.display='none'; imgClosed.style.display='block' }, 140)
  }
}

function triggerMilestone(){
  playMilestoneSound()
  burstConfetti()
  if(imgMilestoneSrc){
    const old = imgClosed.src
    imgClosed.src = imgMilestoneSrc
    setTimeout(()=>{ imgClosed.src = old }, 1800)
  }
}

function burstConfetti(){
  const n = 36
  for(let i=0;i<n;i++){
    const el = document.createElement('div')
    el.style.position='fixed'
    el.style.left = (50 + (Math.random()-0.5)*40) + '%'
    el.style.top = (40 + Math.random()*20) + '%'
    el.style.width = el.style.height = (6 + Math.random()*8) + 'px'
    el.style.background = ['#ffd166','#06d6a0','#118ab2','#ef476f'][Math.floor(Math.random()*4)]
    el.style.borderRadius = '3px'
    el.style.zIndex = 9999
    el.style.transform = 'translate(-50%, -50%) rotate(' + (Math.random()*360) + 'deg)'
    el.style.opacity = '1'
    el.style.transition = 'transform 1.6s ease, opacity 1.6s ease'
    document.body.appendChild(el)
    setTimeout(()=>{el.style.transform = 'translate(' + ((Math.random()-0.5)*800) + 'px, ' + (400 + Math.random()*200) + 'px) rotate(' + (Math.random()*720) + 'deg)'; el.style.opacity = '0'},10)
    setTimeout(()=>el.remove(),1700)
  }
}

// bot
toggleBot.addEventListener('click', ()=>{ if(!botRunning) startBot(); else stopBot(); })
function startBot(){ botRunning = true; toggleBot.textContent = 'หยุด'; botInterval = setInterval(()=>{ doClick(window.innerWidth/2, window.innerHeight/2) }, Number(botSpeed.value)) }
function stopBot(){ botRunning = false; toggleBot.textContent = 'เริ่ม'; clearInterval(botInterval); botInterval = null }

// leaderboard
function loadLB(){ try{ return JSON.parse(localStorage.getItem(LB_KEY) || '[]') }catch(e){ return [] } }
function saveLB(arr){ localStorage.setItem(LB_KEY, JSON.stringify(arr)) }
function renderLB(){
  const arr = loadLB().sort((a,b)=>b.score-a.score).slice(0,8)
  if(arr.length===0){ leaderboardEl.textContent = 'ยังไม่มีคะแนน'; return }
  leaderboardEl.innerHTML = ''
  arr.forEach((r,idx)=>{
    const row = document.createElement('div')
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.gap='12px'; row.style.padding='4px 6px'; row.style.alignItems='center'
    row.innerHTML = `<div style="font-weight:700">${idx+1}. ${escapeHtml(r.name)}</div><div style="font-weight:800">${Number(r.score).toLocaleString()}</div>`
    leaderboardEl.appendChild(row)
  })
}

// submit score + resssssss รีเซ็ต
submitScore.addEventListener('click', ()=>{
  const name = (nameInput.value || 'Guest').trim().slice(0,32)

  if(name.toLowerCase() === 'resssssss'){
    if(confirm('ต้องการรีเซ็ตคะแนนทั้งหมดใช่ไหม?')){
      localStorage.removeItem(LB_KEY)
      count = 0
      updateCounter()
      renderLB()
      alert('✅ คะแนนทั้งหมดถูกรีเซ็ตเรียบร้อย!')
    }
    return
  }

  let arr = loadLB()
  const existing = arr.find(r => r.name === name)
  if(existing){
    if(count > existing.score){
      existing.score = count
      existing.time = Date.now()
    }
  } else {
    arr.push({name, score: count, time: Date.now()})
  }
  saveLB(arr)
  renderLB()
  alert('บันทึกคะแนนเรียบร้อย!')
})

// save & reset
saveBtn.addEventListener('click', ()=>{ submitScore.click() })
resetBtn.addEventListener('click', ()=>{ if(confirm('ต้องการรีเซ็ตคะแนนใช่ไหม?')){ count = 0; updateCounter(); localStorage.removeItem(COUNT_KEY) } })

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') }

renderLB(); updateCounter()
hero.tabIndex = 0
</script>
</body>
</html>
